{{#> template}}
  {{#*inline "content"}}
    <main role="main">
        <div class="container">
            <h1>Manage Templates</h1>
            <hr />

            <fieldset class="form-group collapsible">
                <legend style="cursor: pointer" class='togvis sectionTitle'><i class="fa fa-plus"></i>  <span id="reportTitle"></span></legend>
                <div class="contents" style="display: none;">
                    <hr />
                    <div class="form-row">
                        <div>
                            <table id="documentTable">
                                <thead>
                                    <th>Doc No.</th>
                                    <th style="width: 400px">Template Name</th>
                                    <th>Uploaded Date</th>
                                    <th>Active</th>
                                    <th></th>
                                    <th></th>
                                </thead>
                                <tbody id="documentTableBody">
                                    <tr></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <form class="upload">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#uploadModal">Upload New Version</button>
                            </div>
                        </div>
                    </form>
                </div>
            </fieldset>
            <fieldset class="form-group collapsible nofr-section">
                <legend style="cursor: pointer" class='togvis sectionTitle'><i class="fa fa-plus"></i>  Manage NFR Provisions</legend>
                <div class="contents" style="display: none;">
                    <hr />
                    <div class="form-row">
                        <div>
                            <table id="provisionTable">
                                <thead>
                                    <th style="width: 50px">Type</th>
                                    <th style="width: 50px">Group</th>
                                    <th style="width: 50px">Max</th>
                                    <th style="width: 400px">Provision</th>
                                    <th style="width: 200px">Free Text</th>
                                    <th style="width: 200px">Category</th>
                                    <th style="width: 50px"></th><!-- Radio button column -->
                                    <th style="width: 50px"></th><!-- Edit column -->
                                </thead>
                                <tbody id="provisionTableBody">
                                    <tr>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="V" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="1" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="" readonly></td>
                                        <td><input type="text" style="color:gray;width: 100%" value="TEMPLATE VARIABLES - NOFR" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="" readonly></td>
                                        <td><input type="radio" checked></td></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="V" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="2" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="" readonly></td>
                                        <td><input type="text" style="color:gray;width: 100%" value="FEES" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="" readonly></td>
                                        <td><input type="radio"></td></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="O" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="5" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 50px" value="3" readonly></td>
                                        <td><input type="text" style="color:gray;width: 100%" value="REPLACEMENT STATEMENT" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="" readonly></td>
                                        <td><input type="text" style="color:gray;max-width: 200px" value="OFFER PRE" readonly></td>
                                        <td><input type="radio"></td></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <form class="provision">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success">Add a Provision</button>
                            </div>
                        </div>
                    </form>
                </div>
            </fieldset>
            <fieldset class="form-group collapsible nofr-section">
                <legend style="cursor: pointer" class='togvis sectionTitle'><i class="fa fa-plus"></i>  Manage NFR Variables</legend>
                <div class="contents" style="display: none;">
                    <hr />
                    <div class="form-row">
                        <div>
                            <table id="variableTable">
                                <thead>
                                    <th style="width: 500px">Variable</th>
                                    <th></th><!-- Edit column -->
                                </thead>
                                <tbody id="variableTableBody">
                                    <tr>
                                        <td><input type="text" style="color:gray; min-width: 100%" value="TEMPLATE VARIABLES - NOFR" readonly></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" style="color:gray; min-width: 100%" value="FEES" readonly></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" style="color:gray; min-width: 100%" value="REPLACEMENT STATEMENT" readonly></td>
                                        <td><u>Edit</u></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <form class="variable">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success">Add a Variable</button>
                            </div>
                        </div>
                    </form>
                </div>
            </fieldset>
        </div>
        <div id="uploadModal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                <div class="modal-header">
                    <h4 id="uploadTitle" class="modal-title">Upload New Version</h4>
                    <h4 id="confirmTitle" class="modal-title" style="display:none">Confirm Upload</h4>
                </div>
                <div class="modal-body">
                     <form class="upload">
                        <div id="uploadBody">
                            <div class="form-group row">
                                <div class="col-md-12">
                                    <input class="form-control-file" id="uploadFile" style="height: auto" type="file" accept=".docx">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-12">
                                    <label for="uploadTemplateName" style="font-weight:bold">Template Name:</label>
                                    <input id="uploadTemplateName" type="text" class="border border-1 rounded pl-2 ml-2" style="min-width:400px" disabled>
                                </div>
                            </div>
                        </div>
                        <div id="confirmBody" style="display:none">
                            <p>Are you sure you would like to upload this template?</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveButton" class="btn btn-primary" onclick="saveButtonClicked()" disabled>Save</button>
                    <button type="button" id="cancelButton" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="yesButton" class="btn btn-primary" onclick="uploadTemplate()" style="display:none">Yes</button>
                    <button type="button" id="noButton" class="btn btn-secondary" data-dismiss="modal" style="display:none">No</button>
                </div>
                </div>
            </div>
        </div>
        <div id="removeModal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                <div class="modal-header">
                    <h4 id="removeTitle" class="modal-title">Remove Template</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <p>Are you sure you would like to remove this template?</p>
                    </div>
                    <input id="document-template-id" style="display:none" value=""></input>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick='removeTemplate()'>Yes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        var dataArray = [];
        $( document ).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const reportIndex = parseInt(urlParams.get('report'));
            if (reportIndex != 2) {
                $(".nofr-section").hide();
            }
            const reportType = reportIndex == 1 ? "Land Use Report" : reportIndex == 2 ? "Notice of Final Review" : "";
            $("#reportTitle").text(reportType);
            {{#each data}}
            dataArray.push({
                document_type: "{{this.document_type}}",
                template_version: "{{this.template_version}}",
                template_name: "{{this.template_name}}",
                uploaded_date: "{{this.uploaded_date}}",
                active_flag: "{{this.active_flag}}",
                id: "{{this.id}}"
            });
            {{/each}}

            $("#documentTableBody tr").remove();
            var t = ""
            dataArray.sort((a, b) => {
                return parseFloat(b.template_version) - parseFloat(a.template_version);
            })
            for (let entry of dataArray) {
                if (reportType == entry.document_type) {
                   var tr = `<tr id="row-${entry.id}">`;
                    tr += `<td><input type="text" value="${entry.template_version}" class="border border-1 rounded pl-2" style="color:gray; max-width:80px" readonly></td>`;
                    tr += `<td><input type="text" value="${entry.template_name}" class="border border-1 rounded pl-2" id="name-${entry.id}" style="color:gray; width:100%" readonly></td>`;
                    tr += `<td><input type="text" value="${entry.uploaded_date}" class="border border-1 rounded pl-2" style="color:gray; max-width:150px" readonly></td>`;
                    tr += entry.active_flag == 'true' ? `<td value="checked" style='text-align: center;'><input id='radio-${entry.id}' type="radio" name="radioActive" checked></td>` : 
                        `<td value="unchecked" style="text-align: center;"><input id='radio-${entry.id}' type="radio" name="radioActive"></td>`;
                    tr += `<td><button class="btn btn-info" id='view-${entry.id}' onclick="downloadTemplate(${entry.id})">View</td>`;
                    tr += `<td><button class="btn btn-warning remove-template-button" data-id="${entry.id}" data-toggle="modal" data-target="#removeModal">Remove</td>`;
                    tr += "</tr>";
                    t += tr;
                }
            }
            document.getElementById("documentTableBody").innerHTML = t;

            $('input[type=radio]').click(function(){
                const templateId = this.id.replace("radio-", "");
                const reportType = $("#reportTitle").text();
                fetch(`/admin/activate-template/${templateId}/${encodeURIComponent(reportType)}`, {
                    method: 'GET',
                    responseType: 'application/json',
                    })
                .then(res => res.json())
                .then(data => {
                    if (data.errors) {
                        alert(data.errors);
                    }
                })
                .catch(() => location.reload());
                $('input[type=radio]').parent().html().val('unchecked');
                $(this).parent().html().val('checked');
            });
            // used for sorting the radio buttons
            $.fn.dataTable.ext.order['dom-checkbox'] = function  ( settings, col )
                {
                    return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                        return $('input', td).prop('checked') ? '1' : '0';
                    } );
                }
            $('#documentTable').DataTable({
                "paging": false,
                "bFilter": false,
                "columnDefs": [
                {
                    targets: [0,1,2],
                    type: 'string',
                    render: function(data, type, full, meta) {
                        if (type === 'filter' || type === 'sort') {
                            var api = new $.fn.dataTable.Api(meta.settings);
                            var td = api.cell({row: meta.row, column: meta.col}).node();
                            data = $('select, input[type="text"]', td).val();
                        }
                        return data;
                    }
                },
                {
                    targets: 3,
                    orderDataType: "dom-checkbox"
                },
                {
                    targets: [4,5],
                    orderable: false
                }]
            });
            $('#provisionTable').DataTable({
                "paging": false,
                "bFilter": false,
                "columnDefs": [
                {
                    targets: [0,1,2,3,4,5],
                    type: 'string',
                    render: function(data, type, full, meta) {
                        if (type === 'filter' || type === 'sort') {
                            var api = new $.fn.dataTable.Api(meta.settings);
                            var td = api.cell({row: meta.row, column: meta.col}).node();
                            data = $('select, input[type="text"]', td).val();
                        }
                        return data;
                    }
                },
                {
                    targets: 6,
                    orderDataType: "dom-checkbox"
                },
                {
                    targets: 7,
                    orderable: false
                }]
            });
            $('#variableTable').DataTable({
                "paging": false,
                "bFilter": false,
                "columnDefs": [
                {
                    targets: 0,
                    type: 'string',
                    render: function(data, type, full, meta) {
                        if (type === 'filter' || type === 'sort') {
                            var api = new $.fn.dataTable.Api(meta.settings);
                            var td = api.cell({row: meta.row, column: meta.col}).node();
                            data = $('select, input[type="text"]', td).val();
                        }
                        return data;
                    }
                },
                {
                    targets: 1,
                    orderable: false
                }]
            });
        });
        $(document).on("click", ".remove-template-button", function () {
            const documentTemplateId = $(this).data('id');
            $(".modal-body #document-template-id").val(documentTemplateId);
        });
    </script>
    <script>
        let fileBase64;
        const streamToText = async (blob) => {
            const readableStream = await blob.getReader();
            const chunk = await readableStream.read();

            return new TextDecoder('utf-8').decode(chunk.value);
        };

        const bufferToText = (buffer) => {
            const bufferByteLength = buffer.byteLength;
            const bufferUint8Array = new Uint8Array(buffer, 0, bufferByteLength);

            return new TextDecoder().decode(bufferUint8Array);
        };

        document.getElementById('uploadFile').addEventListener('change', function(e) {
            $('#saveButton').prop('disabled', false);
            $('#uploadTemplateName').prop('disabled', false);
            let file = document.getElementById('uploadFile').files[0];
            if (file.name) {
                $('#uploadTemplateName').val(file.name.replace('.docx',''));
            }

            (async () => {
                const fileContent = await file.text();
                const fileContentStream = await file.stream();
                const buffer = await file.arrayBuffer();
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    fileBase64 = reader.result.split('base64,')[1];
                };
                reader.onerror = function (error) {
                    console.log("Error: ", error);
                };
            })();
        });

        $('#uploadModal').on('hidden.bs.modal', function (e) {
            $('#confirmTitle').hide();
            $('#uploadTitle').show();
            $('#confirmBody').hide();
            $('#uploadBody').show();
            $('#yesButton').hide();
            $('#noButton').hide();
            $('#saveButton').show();
            $('#cancelButton').show();
            var input = document.querySelector('input[type="file"]');
            input.value = "";
        })

        function saveButtonClicked() {
            $('#uploadTitle').hide();
            $('#confirmTitle').show();
            $('#uploadBody').hide();
            $('#confirmBody').show();
            $('#saveButton').hide();
            $('#cancelButton').hide();
            $('#yesButton').show();
            $('#noButton').show();
        }

        function uploadTemplate() {
            let f = document.getElementById('uploadFile');
            var input = document.querySelector('input[type="file"]')
            var formData = new FormData();
            const urlParams = new URLSearchParams(window.location.search);
            const reportIndex = parseInt(urlParams.get('report'));
            const reportType = reportIndex == 1 ? "Land Use Report" : reportIndex == 2 ? "Notice of Final Review" : "";
            formData.append('file', input.files[0]);
            formData.append('document_type', reportType);
            formData.append('active_flag', false);
            formData.append('template_name', $('#uploadTemplateName').val());
            fetch('/admin/upload-template', {
                method: 'POST',
                body: formData,
                responseType: 'application/json',
            })
            .then(res => res.json())
            .then(data => {
                if (data.errors) {
                    alert(data.errors);
                } else {
                    location.reload();
                }
            });
        }
  </script>
  <script>
    $("fieldset legend").click(function() {
        $(this).parent().find(".contents").toggle();
        if ($(".fa", this).hasClass("fa-plus")) {
            $(".fa", this).removeClass("fa-plus").addClass("fa-minus");
        } else {
            $(".fa", this).removeClass("fa-minus").addClass("fa-plus");
        }
    });
  </script>
  <script>
    function downloadTemplate(id) {
        $(":button").prop("disabled", true);
        const template_name = $(`#name-${id}`).val();
        fetch(`/admin/download-template/${id}`, {
            method: "GET",
        })
        .then((res) => res.blob())
        .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = template_name + ".docx";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            $(":button").prop("disabled", false);
        })
        .catch(() => {
            $(":button").prop("disabled", false);
            console.log("Error downloading the template");
        });
    }

    function removeTemplate() {
        const id = $("#document-template-id").val();
        const urlParams = new URLSearchParams(window.location.search);
        const reportIndex = parseInt(urlParams.get('report'));
        const reportType = reportIndex == 1 ? "Land Use Report" : reportIndex == 2 ? "Notice of Final Review" : "";
        fetch(`/admin/remove-template/${reportType}/${id}`, {
            method: "GET",
        })
        .then((res) => res.json())
        .then((resJson) => {
            $(`#row-${id}`).remove();
            $(`#radio-${resJson.id}`).prop('checked', true);
        })
        .catch(() => {
            console.log("Error removing the template");
        });
    }
  </script>
  {{/inline}}
{{/template}}